---
title: åŠ¨æ€ä»£ç†
date: 2023-11-15 18:17:29
tags:
- åŠ¨æ€ä»£ç†
categories:
- Java
- åŠ¨æ€ä»£ç†
---

### ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Ÿ

åŠ¨æ€æ˜¯æŒ‡è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºæŸäº›æ¥å£çš„å®ä¾‹å¯¹è±¡ï¼Œå½“è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä¼šè¢«åˆ†å‘åˆ°InvocationHandlerçš„invokeæ–¹æ³•ä¸­ï¼Œä»£ç†æ˜¯æŒ‡åŠ¨æ€åˆ›å»ºçš„æ¥å£å®ä¾‹å¯¹è±¡å¯ä»¥å¯¹æŸä¸ªå¯¹è±¡åšä»£ç†ï¼Œè¿›è¡Œhookç­‰æ“ä½œ



### åº”ç”¨åœºæ™¯

- ä¸ºæ¥å£æ·»åŠ ç»Ÿä¸€é€»è¾‘å¤„ç†
- ç»“åˆåå°„åŠ¨æ€æ›¿æ¢æ¥å£å®ç°
- é¢å‘åˆ‡é¢ç¼–ç¨‹



### ä¸ºæ¥å£åšç»Ÿä¸€é€»è¾‘å¤„ç†

ä½¿ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆå®ç°æŸä¸ªæ¥å£ä»£ç†å¯¹è±¡ç„¶ååœ¨invocationHandlerä¸­åšé€šç”¨é€»è¾‘å¤„ç†ï¼Œä¾‹å¦‚Retrofitä¸­å·§å¦™åˆ©ç”¨åŠ¨æ€ä»£ç†å®ç°ç½‘ç»œè¯·æ±‚

ç®€åŒ–ç‰ˆä»£ç ç¤ºä¾‹

```kotlin
fun main(args: Array<String>) {
    // ä»£ç†æ¥å£
    proxyInterface()
}

private fun proxyInterface() {
    val httpClient = HttpClient.Builder().build()
    httpClient.create(Api::class.java).request()
}

class HttpClient {
    class Builder {
        fun build(): HttpClient {
            return HttpClient()
        }
    }

    @Suppress("UNCHECKED_CAST")
    fun <T> create(server: Class<T>): T {
        return Proxy.newProxyInstance(server.classLoader, arrayOf(server)) { proxy, method, args ->
            println("proxy ${method.name}")
        } as T
    }
}

/**
* è¯·æ±‚æ¥å£
*/
interface Api {
    fun request()
}
```

æ‰“å°ç»“æœ

```kotlin
proxy request

Process finished with exit code 0
```



### ç»“åˆåå°„åŠ¨æ€æ›¿æ¢æ¥å£å®ç°

é€šè¿‡åå°„æ›¿æ¢é™æ€æˆå‘˜å¯¹è±¡ä¸ºåŠ¨æ€ä»£ç†å¯¹è±¡ï¼ˆå®ç°äº†åŒæ ·çš„æ¥å£ï¼‰ï¼Œä»è€Œå®ç°hookï¼Œå¯¹é™æ€æˆå‘˜æ“ä½œä¸€æ¬¡æ“ä½œç»ˆèº«å—ç”¨ğŸ˜­

åœ¨Androidç³»ç»Ÿä½ç‰ˆæœ¬ï¼ˆå¥½åƒæ˜¯8.0ä»¥å‰ï¼‰,AMSè·å–æ˜¯é€šè¿‡ActivityManagerNativeçš„getDefaultæ–¹æ³•è·å–çš„ï¼ŒgetDefaultè¿”å›çš„æ˜¯ActivityManagerNativeé™æ€æˆå‘˜gDefaultï¼ŒæŸäº›æ’ä»¶åŒ–æ¡†æ¶é€šè¿‡åŠ¨æ€ä»£ç†ç”ŸIActivityManagerä»£ç†å¯¹è±¡å¹¶åå°„æ›¿æ¢gDefaultï¼Œå®ç°å¯¹ActivityManagerNativeçš„hook

ç®€åŒ–ç‰ˆç¤ºä¾‹ä»£ç 

```kotlin
fun main(args: Array<String>) {
    // ä»£ç†hook
    proxyForHook()
}

private fun proxyForHook() {
   
    val proxy = Proxy.newProxyInstance(
        IActivityManager::class.java.classLoader, arrayOf(IActivityManager::class.java)
    ) { proxy, method, args ->
        println("proxy activitymanager")
    }

    val mInstanceField = Class.forName("Singleton").getDeclaredField("mInstance")
    mInstanceField.isAccessible = true
    val gDefaultField = Class.forName("ActivityManagerNative").getDeclaredField("gDefault")
    gDefaultField.isAccessible = true
    val gDefault = gDefaultField.get(null)
    mInstanceField.set(gDefault, proxy)
    ActivityManagerNative.getDefault()?.startActivity()
}


class ActivityManagerNative {
    companion object {
        @JvmStatic
        private val gDefault = object : Singleton<IActivityManager>() {
            override fun create(): IActivityManager {
                return ActivityManager()
            }

        }

        fun getDefault(): IActivityManager? = gDefault.get()
    }


}

interface IActivityManager {
    fun startActivity()
}

class ActivityManager : IActivityManager {

    override fun startActivity() {
        println("start Activity")
    }
}


abstract class Singleton<T> {
    private var mInstance: T? = null
    protected abstract fun create(): T
    fun get(): T? {
        synchronized(this) {
            if (mInstance == null) {
                mInstance = create()
            }
            return mInstance
        }
    }
}
```

æ‰“å°ç»“æœ

```kotlin
proxy activitymanager

Process finished with exit code 0
```



### é¢å‘åˆ‡é¢ç¼–ç¨‹

å¦å¤–åŠ¨æ€ä»£ç†è¿˜å¯ä»¥ç”¨æ¥åšAopé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¾‹å¦‚éœ€è¦åœ¨è¢«ä»£ç†å¯¹è±¡æ‰§è¡ŒæŸä¸ªæ“ä½œå‰åæ·»åŠ å…¶ä»–æ“ä½œä¾‹å¦‚æ‰“å°æ—¥å¿—

ç¤ºä¾‹ä»£ç 

```kotlin
fun main(args: Array<String>) {
    // ä»£ç†AOP
    proxyForAop()
}

fun proxyForAop() {
    val person = Person()
    val personProxyHandler = PersonProxyHandler(person)
    val personProxy = Proxy.newProxyInstance(
        person.javaClass.classLoader,
        arrayOf(IAnimal::class.java),
        personProxyHandler
    ) as IAnimal
    personProxy.eat()
}

class PersonProxyHandler(private val person: Person) : InvocationHandler {

    override fun invoke(proxy: Any?, method: Method, args: Array<out Any>?): Any {
        println("doSomething before eat")
        method.invoke(person)
        println("doSomething after eat")
        return Unit
    }

}

class Person : IAnimal {
    override fun eat() {
        println("start eat")
    }

}

interface IAnimal {
    fun eat()
}
```

æ‰“å°ç»“æœ

```kotlin
doSomething before eat
start eat
doSomething after eat

Process finished with exit code 0
```

